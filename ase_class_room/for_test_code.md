<!-- $theme: gaia -->

# 自動テストに移行するには

### 色々考えて意見も募ってみた

---

<!-- page_number: true -->

## お品書き

1. いまさら自動テストの利点
2. 自動テストを阻害する要因と対処
2.1. 誤解による要因
2.2. 心理的要因
2.3. スキル的要因
2.4. 仕組み的要因
3. まとめ〜自動テストを運用するには〜
4. おまけ

---

#### 1. いまさら自動テストの利点

---

#### 1. いまさら自動テストの利点

なんで今更？いえむしろ、まだ言わなきゃいけないのかって領域にだんだん差し掛かってます。

なんでこんな事を書くかと言うと、クラウド環境や変化の激しいプラットフォームにおいて、運用するだけでも互換の為の試験が発生するからです。

例えば非常に非常に簡単な一例を出します。

---

#### 1. いまさら自動テストの利点

**Java の寿命は最長三年です**

何を言っているかと言うと、安定安定と言われた Java が、半年ごとにバージョンアップを行い、どんどん EOL (SATSUGAI) すると言っています。  
上記の 3 年は、LongTimeSupport 版で３年という意味なのです。

つまり、３年に一度はどう足掻いてもオーバーホールないしは互換テストをやらなければいけません。

これは一つ極端な例ですが、他にも

---

#### 1. いまさら自動テストの利点

**クラウドに載せたら思ってたのと違う**

新しいプラットフォームあるあるですね。  
昨今は運用プラットフォームもどんどん現れ、全部作って載せたら動かない…なんて悲惨な経験ありませんか？

このルネッサンス期では後戻りなんてザラに起こりますので、もういい加減一筆書きの WF が厳しくなっています。  
小さく作ってバージョンを上げていく開発では、回帰試験は必須ですよね？

---

#### 1. いまさら自動テストの利点

**フレームワークのセキュリティパッチ**

昨今フレームワークのない開発なんてありえません。  
すると当然この問題が発生します。

動作をどう保証する？手でやる？マジで？

だいたい 1 年もすればこう言うこともザラに起きます。  
セキュリティは、攻撃ありきの進化なので、絶対がありえないと言うことは覚悟すべきでしょう。

---

#### 1. いまさら自動テストの利点

利点：

* 回帰試験実行コストの低減
* テストを実行する条件下で、少なくとも単体レベルで仕様通りに動く証明になる

欠点：

* 製造の一時コストは上がる
* 高い確率で、設計、テストの教育コストがかかる
* プロジェクトの進め方を変える必要が出る

---

## 設計/テストに教育はまだわかる。
## 進め方が変わるってどういうこと？

---

#### 2. 自動テストを阻害する要因と対処

---

#### 2.1. 誤解による要因

##### 「テストコードはコストがかかりすぎる！手でやった方がマシ！」は誤解

---

#### 2.1. 誤解による要因

よくみなさん単体試験と聞いて、テスト仕様書を Excel で書きますよね？  
テストデータをテーブルごとに定義して、「XX画面でYYしたらZZが表示される」とか…

でもまずそこから指摘です。

それは昨今単体テストとは呼びません。  
バッチで全てが解決した手続き時代の単体テストを、複雑化したこの時代に単体と呼んではいけません。  
それは **結合テスト** です。

---

#### 2.1. 誤解による要因

Wikipedia 様抜粋するも

> 手続き型プログラミングでは、ユニットは、モジュール全体のこともあるが、より一般的には、個々の関数や手続きである。オブジェクト指向プログラミングでは、ユニットは、クラスなどのインタフェース全体だが、個々のメソッドであることもある

とあります。  
古代の因習（手続き時代）に囚われすぎと考えるべきです。

---

#### 2.1. 誤解による要因

実はこの辺がテスト準備が大きくなりすぎる問題に直結します。  
だって考えてみれば当然ですよね？

沢山の小さな機能の集まりをテストしようとすれば、個々の機能に対するデータを作らなければいけない。
そりゃテストコードは書きにくいし、コストがかかりますよ。

例えば

---

#### 2.1. 誤解による要因

アクセス制限のテストを考えたとして

ブラウザからログインしてX機能を呼ぶ…なんてテスト簡単に書けますか？

* アクセス判定を行ってるメソッドに、アカウントとURL突っ込んで OK/NG を確認
* (判定部分をモックで置き換えて)判定が NG だったら「アクセス禁止」の画面を応答する

って分ければなんかテスト書けそうじゃないですか。

---

#### 2.1. 誤解による要因

つまり単体テストと言うのは、「機能を実現する為の個々の処理を個別に確認するもの」なのです。

ここを間違うと、単体テスト工数が跳ね上がりますのでご注意ください（汗

単体テストで個々の API が正しければ、結合さえ間違ってなければ正常動作するわけです。

---

#### 2.2. 心理的要因

---

#### 2.2. 心理的要因

やればわかります。  
テスト書いて来なかった人はテストをやりたがりません。

* メインコードがバグるのに、テストコードがバグらない訳ないではないか

論破そのものは簡単です。

両方意図通り動かないなら、ほぼ確実にテスト落ちますよね。  
二重チェックなのだから、むしろ気づいて良かったのでは？

---

#### 2.2. 心理的要因

とはいえ、心理的に書きたくない人はとことんまで書きません。  
これは割と真面目な話としてです。

実際、作り逃げするメンバー（大抵キーマンではない人）は、作り終わったら抜けてしまいます。  
極論すると「後のことなんてどうだっていい」人なのです。

残る人の為にテストを書かせると言うのは、もはや理屈を通りこして面倒なだけなのです。

---

#### 2.2. 誤解による要因
---

#### 2.3. スキル的要因
---

#### 2.4. ルール的要因
---

#### 3. まとめ〜自動テストを運用するには〜
---

#### 4. おまけ